# 17. 내용 협상과 트랜스코딩
## 17.1 내용 협상 기법
- 서버에 있는 페이지들 중 어떤 것이 클라이언트에게 맞는지 판단하는 세가지 방법 존재
  - 클라이언트 주도 협상
  - 서버 주도 협상
  - 투명한 협상 

## 17.2 클라이언트 주도 협상
- 서버입장에서 가장 쉬움
- 각 페이지에 두번의 요청이 필요함
  - 처음 : 목록을 얻음
  - 두번째 : 선택한 사본을 얻음
  - 느리고 지루한 과정, 클라는 짜증남
- 선택지 목록을 보내는 두 방법
  - 여러 버전에 대한 링크와 설명이 담긴 HTML 페이지
  - 300 Multiple Choices 응답 코드로 HTTP/1.1 응답 돌려줌
- 선택지 목록 만큼의 여러 URL을 요구함

## 17.3 서버 주도 협상
- 클라이언트의 요청 헤더에 무엇을 선호하는지 정보를 주어서 서버가 결정
- http 서버가 적절한 응답을 계산하기위해 사용하는 메커니즘 2가지
  - 내용 협상 헤더들(Accept 관련 헤더 등)을 살펴보고 적절한 응답 헤더 준비
  - 내용 협상 헤더 외에 User-Agent 헤더등을 살펴보고 응답 헤더 준비
### 내용 협상 헤더
- Accept : 어떤 미디어 타입으로 보내도 되는지 / 엔티티 헤더의 Content-Type 과 짝을 이룸
- Accept-Language : 어떤 언어로 보내도 되는지 / Content-Language
- Accept-Charset / Content-Type
- Accept-Encoding / Content-Encoding
- http 는 stateless 니까 매 요청마다 선호 정보 반드시 보내야함
- 클라이언트의 선호 정보에는 품질값(quality value) 넣어서 우선순위 넣을 수 있음(0.0 ~ 1.0)

### 아파치의 내용 협상
- 웹 사이트 컨텐츠의 제공자에게 달려있다
- 색인 페이지를 여러 버전으로 제공해 주려면 각각의 버전에 해당하는 파일을 아파치 서버의 적절한 디렉터리에 넣어주어야 한다
  - variant를 갖는 웹 사이트의 각 uri를 위한 type-map 파일 만들어, 각각에 대응하는 내용 협상 헤더를 나열한다
  - 아파치가 그 디렉터리에 자동으로 type-map 파일을 생성하도록 하는 MultiViews 지시어를 켠다
- MultiViews
  - access.conf 파일에서 Options 지시어를 통해 Multiviews 를 선언하면 켜짐
  - 어떤 요청의 이름에 딱 맞는 리소스가 없다면, 그 이름을 포함한느 모든 파일을 살펴보고 type-map 파일을 생성한다
  - 이름에 근거해서 각 파일에 대응하는 적절한 내용 협상 헤더를 추측한다

## 17.4 투명 협상
- 클라이언트 입장에서 협상하는 중개자 프록시를 둠
- 클라이언트와의 메시지 교환 최소화
- 서버 주도 협상으로 인한 부하를 제거
- 조건 : 프록시가 똑똑해야함
  - 컨텐츠 요청을 보고 클라이언트의 요구사항을 파악해야함
  - 서버가 프록시에게 어떤 요청 헤더를 검새햐아 하는지 말해줄 수 있어야 함
- HTTP/1.1 명세에는 없는 협상, 대신 Vary 헤더는 정의되어 있음
-  Vary 헤더 : 서버가 응답에 넣고, 중개자(프록시) 에게 내용 협상을 위해 어떤 헤더를 사용하고 있는지 알려줌
### 캐시와 얼터네이트
- 캐시는 같은 url 이라고 같은 협상 내용으로 보내지 않는다
- 매번 서버에 협상 요청 내용을 보내고, 다른 응답이라면 그걸 캐시에 저장해두고 응답한다
- 결국 같은 url 에 여러 페이지가 캐싱될 수 있다(이런 다른 버전을 배리언트 나 얼터네이트 라고 한다)

### Vary 헤더
- 서버가 문서를 선택하거나 커스텀 컨텐츠를 생성할 대 고려한 클라이언트 요청 헤더 모두를 나열한다
- 새로운 요청과, 기존에 갖고있던 캐싱된 응답의 Vary 헤더의 값이 같은지 확인해야 한다

## 17.5 트랜스코딩
- 서버가 클라이언트의 요구에 맞는 문서를 갖고 있지 않다면?
- 에러로 응답해야 하겠지만, 이론적으로 서버는 기존의 문서를 클라이언트가 사용할 수 있는 무언가로 변환 가능하고, 이 옵션을 트랜스코딩이라고 함
- 트랜스 코딩에는 3종류가 있다

### 포맷 변환
- 데이터를 클라이언트가 볼 수 있도록 포맷을 바꾸는 것
- 고해상도 이미지를 저해상도로 바꾼다던가
- 트랜스코딩은 컨텐츠 인코딩, 전송 인코딩과는 다르다
  - 트랜스코딩은 특정 클라이언트에서 볼 수 있게 하는것, 후자는 효율적, 안정적인 전송을 위한 것

### 정보 합성
- 정보 합성 : 문서에서 정보의 요점을 추출하는 것
- 포털 사이트의 웹페이지 디렉터리와 같은 자동화된 웹페이지 분류 시스템에 의해 종종 사용됨

### 컨텐츠 주입
- 웹문서의 양을 늘리는 트랜스코딩
- 자동 광고 생성, 사용자 추적 시스템 등이 있음

### 트랜스코딩 vs 정적으로 미리 생성해놓기
- 정적인건 너무나 바리에이션이 다양해질수록 공간 낭비라 현실적이지 못함
- 컨텐츠 주입같은건 정적인걸로 하면 개인화가 안됨
- 트랜스코딩을 프록시나 외부 서버에 위임 하면 부하도 줄음
