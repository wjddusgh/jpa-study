# 3. 구글 맵
### 웹 기반 지도 서비스
- 위성 이미지
- 거리 뷰
- 실시간 교통상황
- 경로 계획
### 엄청 복잡한 제품이므로, 설계에 앞서 어떤 기능에 초점을 맞추어야 하는지 확인해야 한다

## 문제 이해 및 설계 범위 확정
### 기능 요구사항
- DAU : 10억
- 지원할 주요 단말은 스마트폰
- 세가지 기능
  - 사용자 위치 갱신
  - 경로 안내 서비스(ETA 서비스 포함)
  - 지도 표시
 
### 비기능 요구사항 및 제약사항
- 정확도 : 사용자에게 잘못된 경로 안내하면 안된다
- 부드러운 경로 표시
- 데이터 및 배터리 사용량: 모바일 단말에 아주 중요한 요구사항
- 가용성 맟 규모 확장성

# 지도 서비스 관련 기본 개념 및 용어
## 지도101(입문)
### 측위 시스템
위도, 경도
### 3차원 위치의 2차원 변환
- 지도 투영법 또는 도법 이라 부름
- 메르카토르 도법, 퍼스 퀸쿤셜 도법등 여러 도법이 있고, 구글 맵은 웹 메르카토르 도법을 택함
- 웹 메르카토르 도법
  - 위도와 경도가 이루는 각도를 정확하게 보여주는 도법
  - 고위도로 갈수록 면적, 형상이 왜곡됨
  - 각도를 보고 목적지에 가기엔 좋아서 채택한다고 함
### 지오코딩
- 주소를 지리적 측위 시스템의 좌표로 변환하는 프로세스
- 좌표를 주소로 변환하는 프로세스는 역 지오코딩이라 부름
- GIS(지리정보시스템) : 도로망, 지리정보 가지고 있음
- GIS 의 주소정보를 인터폴레이션을 통해 지리좌표로 변환할 수 있다고 함
  - 지오코딩으로 주소의 정확한 지리좌표를 모를 때만 유추 
### 지오해싱
- 지도 위 특정 영역을 영문자와 숫자로 구성된 짧은 문자열에 대응시키는 인코딩 체계
![geohash](https://github.com/wjddusgh/jpa-study/assets/69251780/029b3c82-ccfb-4773-87fe-aec77825196d)

### 지도표시(렌더링)
- 지도를 화면에 표시할 땐 하나의 이미지로 표시하는 대신, 작은 타일로 쪼개어 표시함
- 지도의 확대/축소 지원하려면 확대 수준에 따라 다른 종류의 타일을 준비해야함
  - 한국 전체 지도를 볼때 세세한 수십만 타일을 다 다운로드할 필요는 없다! 작은 이미지 하나만 다운로드 받으면 충분

## 경로 안내 알고리즘을 위한 도로 데이터 처리
- 대부분의 경로 탐색 알고리즘은 다익스트라, A* 경로 탐색 알고리즘의 변종임
- A* 알고리즘 : 다익스트라 처럼 최단 거리를 찾지만, 휴리스틱을 사용하여 시작, 목표까지의 최단거리를 더 효율적으로 찾는다고 함
- 경로 탐색 알고리즘의 성능은 주어진 그래프 크기에 아주 민감함
  - 전세계 도로망을 하나의 그래프로 표현하면 메모리 낭비, 알고리즘 성능도 낮음
  - 지도 표시에 사용한 타일 기반 분할법 처럼 도로망 그래프를 더 작은 단위로 분할함
  - 각 격자는 경로 안내 타일 이라 부르고, 도로로 연결된 다른 타일에 대한 참조를 유지함
  - 언제든 불러올 수 있는 경로 안내 타일로 분할해놓으면 메모리 요구량도 낮추고, 한번에 처리할 경로 양이 줄어 경로 탐색 성능도 좋아짐  
![grafi-e-nodi](https://github.com/wjddusgh/jpa-study/assets/69251780/c1af4de5-2673-4151-badd-0df20a516b86)
  
### 계층적 경로 안내 타일
- 보통 구체성 정도를 상,중,하 세가지로 구분하여 경로 안내 타일을 준비함
  - 상 : 매우 세밀한 내용, 지방도 데이터를 둠
  - 중 : 더 넓은 지역을 커버하며 간선 도로 데이터를 둠
  - 하 : 매우 큰 영역을 커버하며 도시와 도시를 잇는 고속도로 데이터를 둠
- 계층이 다른 경로 안내 타일끼리의 연결선도 존재함(국도 -> 고속도로 타듯이)

## 개략적 규모 추정
### 저장소 사용량
- 메타데이터: 지도 타일 메타데이터는 무시할 정도로 아주 작음
- 도로 정보: 수 TB 용량의 도로데이터, 경로 안내 타일로 변환해도 비슷한 용량
- 세계 지도
  - 지도를 타일로 만들 때, 한번의 확대는 4장의 타일로 분할됨
  - 총 21단계의 확대/축소가 있는걸로 설계
  - 최대 확대 기준으로 약 4.4조개의 타일 필요
    - 256*256 png파일 하나당 100KB * 4.4조 = 약 440PB
    - 지구표면의 90%는 자연 그대로의 인간이 안사는 지역이므로 압축해버린다면 약 80~90% 절감 가능 : 약 50PB
    - 나머지 축소되는 이미지들은 단계당 1/4 만큼의 타일이 필요함
      - 50 + 50*(1/4) + 50*(1/4)^2 + ... = 약 67PB
### 서버 대역폭
- DAU 10억
- 사용자는 경로 안내 기능을 주당 35분 사용
- 환산시 하루에 약 3000억 초 사용
- 24시간동안 3000억 건의 요청 발생 : 약 300만 QPS
- 초당 발생하는 변경내역을 클라이언트에서 모았다가 15초에 한번씩 보내면 서버 요청은 크게 감소할 것

# 설계

## 데이터 모델
- 데이터 종류
  - 경로 안내 타일
  - 사용자 위치
  - 지오코딩 데이터
  - 미리 계산해 둔 지도 타일
### 경로 안내 타일
- 일반적으로 그래프 데이터는 인접리스트 형태로 메모리에 저장하지만 경로 안내 타일은 너무 크다
- 보통 S3 같은 객체 저장소에 보관하고, 경로 안내 서비스에서 적극적으로 캐싱하는 것
- 객체 저장소에는 지오해시 기준으로 분류하면 위도,경도 주어졌을 때 신속하게 찾을 수 있다
### 사용자 위치
- 엄청난 양싀 쓰기 연산이 발생
- 보통 카산드라가 쓰기 연산 처리가 좋고, 수평적 규모 확장이 가능하다고 함
### 지오코딩 데이터
- 읽기 연산은 빈번한 반면 쓰기 연산은 매우 드물다
- 레디스 처럼 빠른 읽기 연산을 지원하는 키-값 저장소가 적당함
### 미리 계산해 둔 지도 타일
- 특정 영역 지도 요청 시 인근 도로 정보를 취합하여 모든 도로 및 관련 상세정보가 포함된 이미지를 만들어야함
- 계산 자원을 많이 사용하는데, 중복으로 이미지 요청하는 경우가 많은 케이스
- 한번만 계산하게끔 캐시하는 전략 필요
- CDN 적극 활용
## 위치 서비스
- 주기적으로 t초 마다 클라이언트의 위치를 서버에 전송하는 데이터 스트림
  - 시스템 점진적 개선 가능
    - 실시간 교통상황 모니터링
    - 새로 만들어진 도로, 폐쇄된 도로 탐지
    - 개인화 학습
  - ETA 산출이 더 정확해짐
- 사용자 위치는 계속 변화하며, 이전 정보는 무용해지기 때문에 데이터 일관성보다는 가용성이 우선시됨
  - CAP 중에 AP 에 중점을 둠
- 데이터베이스 키: (user_id, timestamp)
  - user_id: 파티션 키, 특정 사용자의 최근 위치를 신속히 읽어내기 위해서
  - timestamp: 클러스터링 키, 이 값에 따라 정렬됨
- 데이터베이스 값: 위도/경도 쌍
### 사용자 위치 데이터는 어떻게 이용되는가
- 사용자 위치를 데이터베이스에 기록하는것과 별도로 카프카 같은 메시지큐에 로깅하여 다양한 서비스에서 컨슘함
- 사용자 위치를 사용하는 서비스
  - 실시간 교통 상황 서비스
  - 개인화를 위한 기계 학습 서비스
  - 경로 안내 타일 처리 서비스
  - 분석 서비스
## 지도 표시
### 클라이언트가 지도 타일을 서버에서 가져오는 방법
미리 만들어둔 지도 타일을 가져오면 됨
### 최적화
- 벡터 사용
  - WebGL : 웹 브라우저에서 2D,3D 렌더링하기 위한 js api로, gpu 사용하여 그래픽 처리할 수 있게 함
  - 기존 이미지 형식 지도는 레스터 지도인데, 벡터 지도는 경로, 다각형등의 벡터 정보를 보냄
  - 이미지보다 월등한 압축률, 매끄러운 지도 확대 경험의 장점
## 경로 안내 서비스
![image (4)](https://github.com/wjddusgh/jpa-study/assets/69251780/13ce9818-9ee5-40de-8f36-8cb2389afe12)

## 전송 프로토콜
- 서버에서 클라이언트로 데이터를 보내는 데 활용할 수 있는 프로토콜
  - 모바일 푸시 알림
  - 롱 폴링
  - 웹 소켓
  - 서버 전송 이벤트(SSE)
### 모바일 푸시 알림
보낼 수 있는 크기가 매우 제한적(iOS 경우 최대 4096바이트), 사용하지 않는게 바람직함
### 롱 폴링
서버에 주는 부담이 웹 소켓보다 큼
### 웹 소켓
웹 소켓이나 SSE 가 괜찮은 방법, 웹 소켓은 양방향 통신을 지원함
