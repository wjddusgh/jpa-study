# 08 클라우드 스트림으로 확장하기

# 메시지 브로커, 메시지 기반 시스템의 핵심
- 리액티브 시스템의 본질 : 메시지 중심의 통신
- 모놀리틱 -> MSA 로 위치 투명성을 보장하는 탄력적인 시스템 만드는 것
- 서비스 관리, 모니터링 및 서비스 스케일링과 같은 새로운 범주의 문제점 가짐

## 서버사이드 로드 밸런싱
- 분산 시스템 개발 초기엔 위치 투명성, 탄력성을 얻는 방법중 하나로 HAProxy/Nginx 같은 외부 로드밸런서 사용(진입점 혹은 전체 시스템 대한 중앙 로드 밸런서로)
- 로드 밸런서
  - 하위 인스턴스의 레지스트리 역할 수행
  - 전체 그룹 로드 및 메트릭을 기반으로 스케일링 프로세스 시작 가능
  - 문제점
    - 로드가 높을 때 로드 밸런서가 시스템의 핫스팟 될 수 있음
    - 로드밸런서 비용이 높다
    - 백업 시스템에도 로드 밸런서가 필요할 수도 있다
    - 로드밸런서 관리, 모니터링을 위한 인프라 비용 추가  

## 스프링 클라우드와 Ribbon을 이용한 클라이언트 사이드 로드 밸런싱
- 각 서비스가 다른 서비스의 가용한 인스턴스를 확인하기 위하여 특정한 클라이언트와 통신을 시도
- 로드 밸런서는 각 서비스의 일부
- 전용 외부 로드밸런서에 대한 의존성 제거해줌 -> SPoF 없어져 확장성 향상
- 서비스 가용성 정보는 시스템의 나머지 서비스에서 어떻게든 접근할 수 있어야함
- Ribbon
  - 넷플릭스가 만든 클라이언트측 로드밸런서
  - 서비스 인스턴스 목록 사용해 로드 관리하는 방법
    - 각 로드밸런서는 동기화 안되므로 한 인스턴스에 과부하 줄수도 있음
    - 리액티브 요구사항과 거리가 멈
  - 유레카 같은 서비스 레지스트리와 통합한 방법
    - 서비스 복제본에 대한 가용성을 지속적으로 업데이트
    - 작은 서비스 클러스터에서 잘 작동
    - 시스템 상태 정보 업데이트, 유지에 많은 노력 필요(spof)
    - 클러스터가 동적일수록 서비스 레지스트리 정보가 안맞을 수 있음

## 탄력적이고 신뢰성 있는 메시지 전달 계층 역할의 메시지 브로커
- 메시지큐를 명시적으로 사용해 로드밸런싱
- 서버사이드 로드밸런싱과 비슷하지만, 비동기적으로 동작함
- 메시지큐는 독립적인 서비스로 작동
  - 메시지를 통해 시스템에 있는 워커의 수 알 수 있고, 이를 기반으로 부하 관리 가능
  - 각 워커는 내부적으로 배압 관리, 메시지 수신 가능
  - spof 같지만 아님, 메시지 큐에 넣고 빼고가 독립적이고, 메시지큐 복제로 확장성도 향상
  - 특정 그룹에 메시지 몰리는 부하 막기 위해 메시지 브로커 사용 가능
  - 메시지 브로커는 리밸런싱 메커니즘을 통해 부하 관리 가능
  - 메시지 브로커가 리액티브 시스템이면 아주 좋아짐 
  - 메시지 브로커가 손상된 경우에도 메시지 유실은 안일어남

## 메시지 브로커의 현황
- 다양한 오픈소스 솔루션 존재, 카프카가 주로 쓰이는듯
   
