# 5. 연관관계 매핑 기초

- 엔티티들은 대부분 다른 엔티티와 연관관계가 있다.
  - ex. 주문 - 상품 (1:N), 상품 - 카테고리, 상품 - 재고 등
- 매핑해야할 객체와 테이블은 완전히 다른 특징을 가진다.
  - 객체: 참조를 통한 관계
  - 테이블: 외래 키를 통한 관계
- 객체 관계 매핑(ORM)에서 가장 어려운 부분이 바로 **객체와 테이블 연관관계 매핑** (이번 챕터의 목표)
- 연관관계 매핑 핵심 키워드
  - 방향: 단방향, 양방향으로 양쪽 엔티티가 모두 서로 참조하는것이 양방향이다
  - 다중성: 1:N, N:1, 1:1, N:M 다중성이 있다
  - 연관관계의 주인: 객체를 양방향 연관관계로 만들면 연관관계의 주인을 정해야 한다

# 5.1 단방향 연관관계
## 다대일 단방향 관계
회원 팀 관계 예시
- 객체 연관관계
  - 회원과 팀은 단방향관계로 회원은 팀을 참조를 통해 알수 있지만 팀은 회원을 모른다
- 테이블 연관관계
  - 회원과 팀은 양방향관계로 외래 키를 통해 서로가 서로를 알 수 있다    

## 5.1.3 객체 관계 매핑
```java
@Entity
public class Member {
  ...
  
  @ManyToOne
  @JoinColumn(name="TEAM_ID")
  private Team team;
  
  ...
}

@Entity
public class Team {
  @Id
  @Coluimn(name = "TEAM_ID")
  private String id;
  
  ...
} 
```
- @ManyToOne: 다대일(N:1)관계라는 매핑 정보. 연관관계 매핑시 다중성 나타내는 애노테이션 필수
- @JoinColumn: 외래 키 매핑시 사용, name 속성을 통해 외래 키 이름 지정한다(기본값이 있어서 생략 가능)

## 5.1.4 @JoinColumn

|속성|기능|기본값|
|------|--------|------------|
|name|매핑할 외래 키 이름|필드명 + '_' + 참조하는 테이블의 기본 키 컬럼명 |
|referencedColumnName|외래키가 참조하는 대상 테이블의 컬럼명|참조하는 테이블의 기본 키 컬럼명 |
|foreignKey(DDL)|외래 키 제약조건을 직접 지정할 수 있다. 이 속성은 테이블 생성시만 사용 ||
|unique,nullable,insertable,...|@Column의 속성 ||
- @JoinColumn 생략 시 외래키 찾을 때 기본 전략을 사용한다
  - ex. team 필드의 TEAM_ID 컬럼 -> team_TEAM_ID

## 5.1.5 @ManyToOne

|속성|기능|기본값|
|-------|-------|----------|
|optional|false로 설정하면 연관된 엔티티가 항상 있어야 한다 |true|
|fetch|글로벌 패치 전략을 설정한다 |@ManyToOne=FetchType.EAGER @OneToMany=FetchType.LAZY |
|cascade|영속성 전이 기능을 사용한다 ||
|targetEntity|연관된 엔티티의 타입 정보를 설정한다. 하지만, 이 기능은 거의 사용안함 (컬렉션을 사용해도 제네릭으로 타입정보 알 수 있음)||
targetEntity 사용 예시
```java
@OneToMany
private List<Member> members;

@OneToMany(targetEntity=Member.class)
private List members;
```

# 5.2 연관관계 사용
연관관계를 등록, 수정, 삭제, 조회 하는법 알아보자

## 5.2.1 저장
```java
public void Save() {
  Team t1 = new Team("SKT", "team1");
  em.persist(t1);
  
  Member faker = new Member("member1", "mid");
  faker.setTeam(t1);
  em.persist(faker);
  
  Member zeus = new Member("member2", "top");
  zeus.setTeam(t1);
  em.persist(zeus);
}
```
- jpa는 참조한 객체의 식별자를 외래 키로 사용해서 적절한 등록쿼리를 생성한다
```sql
INSERT INTO TEAM (TEAM_ID, NAME) VALUES ('team1','SKT')
INSERT INTO MEMBER (MEMBER_ID, NAME, TEAM_ID) VALUES ('member1', 'mid' 'team1')
INSERT INTO MEMBER (MEMBER_ID, NAME, TEAM_ID) VALUES ('member2', 'top' 'team1')
```
## 5.2.2 조회
